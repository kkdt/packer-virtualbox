---
- name: Red Hat Registration
  hosts: all
  become: yes
  become_method: sudo
  gather_facts: yes
  tasks:
    - name: Register as user with password, random string subscription name
      community.general.redhat_subscription:
        state: present
        username: "{{ rhsm_username }}"
        password: "{{ rhsm_password }}"
        consumer_name: "{{ query('community.general.random_string', upper=true, numbers=false, special=false) }}"
        auto_attach: true
      when:
        - "ansible_os_family == 'RedHat'"
        - rhsm_username is defined
        - rhsm_username|length > 0
        - rhsm_password is defined
        - rhsm_password|length > 0

- name: Default provisioning
  hosts: all
  become: yes
  become_method: sudo
  gather_facts: yes
  roles:
    - role: vagrant
    - role: virtualbox-guest-additions
#    - role: base
    - role: configure
    - role: clean

- name: Red Hat Registration
  hosts: all
  become: yes
  become_method: sudo
  gather_facts: yes
  tasks:
    - name: Unregister as user with password
      community.general.redhat_subscription:
        state: absent
        username: "{{ rhsm_username }}"
        password: "{{ rhsm_password }}"
      when:
        - "ansible_os_family == 'RedHat'"
        - rhsm_username is defined
        - rhsm_username|length > 0
        - rhsm_password is defined
        - rhsm_password|length > 0